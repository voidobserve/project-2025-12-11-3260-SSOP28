C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        12/05/2025 17:28:59 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KEY_DRIVER
OBJECT MODULE PLACED IN .\Release\Objects\key_driver.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\key_driver.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTO
                    -R(0X000C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(
                    -.\Release\Listings\key_driver.lst) OBJECT(.\Release\Objects\key_driver.obj)

line level    source

   1          #include "key_driver.h"
   2          
   3          #if (TOUCH_KEY_ENABLE || AD_KEY_ENABLE)
              
              enum
              {
                  KEY_SCAN_STATUS_NONE = 0,       // æ— ç‰¹æ®ŠçŠ¶æ€
                  KEY_SCAN_STATUS_TO_NOTIFY,      // å‘é€æŒ‰é”®æ¶ˆæ¯
                  KEY_SCAN_STATUS_TO_END_OF_SCAN, // æŒ‰é”®æ‰«æç»“æŸï¼Œè¿›è¡Œæ”¶å°¾å¤„ç†
              };
              
              static volatile u8 is_key_active; // æŒ‰é”®æ˜¯å¦æœ‰æ•ˆçš„è®¡æ•°å€¼
              
              //=======================================================//
              // æŒ‰é”®æ‰«æå‡½æ•°: æ‰«ææ‰€æœ‰æ³¨å†Œçš„æŒ‰é”®é©±åŠ¨
              //=======================================================//
              // xdata volatile struct key_driver_para *scan_para; // è¦è®©æŒ‡é’ˆæŒ‡å‘xdataåŒºåŸŸçš„å…¨å±€å˜é‡ï¼Œéœ€
             -è¦åŒæ ·å°†æŒ‡é’ˆå˜ä¸ºå…¨å±€å˜é‡
              volatile struct key_driver_para *scan_para; // è¦è®©æŒ‡é’ˆæŒ‡å‘xdataåŒºåŸŸçš„å…¨å±€å˜é‡ï¼Œéœ€è¦åŒæ ·
             -å°†æŒ‡é’ˆå˜ä¸ºå…¨å±€å˜é‡
              void key_driver_scan(void *_scan_para)
              // struct key_driver_para key_driver_scan(struct key_driver_para scan_para)
              {
                  // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)_scan_para; // å
             -‡½æ•°å†…éƒ¨çš„æŒ‡é’ˆåªèƒ½æŒ‡å‘idataç©ºé—´ï¼Œä¸èƒ½æŒ‡å‘å…¨å±€å˜é‡çš„xdataç©ºé—´
                  // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)0x642D; // ç³»ç»
             -Ÿä¼šä¸€ç›´å¤ä½
              
              #if 1
                  u8 key_event = KEY_EVENT_NONE; // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®äº‹ä»¶
                  u8 cur_key_value = NO_KEY;     // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®é”®å€¼
                  u8 key_value = NO_KEY;
              
                  // u8 key_scan_status = KEY_SCAN_STATUS_NONE; // çŠ¶æ€æœºï¼Œè´Ÿè´£æŽ§åˆ¶è¯¥å‡½æ•°å†…çš„è·³è½¬æ“ä½œ /
             -* æŽ§åˆ¶è·³è½¬è¿˜æœ‰é—®é¢˜ï¼Œè¿˜ä¸èƒ½ä½¿ç”¨ */
              
                  scan_para = (struct key_driver_para *)_scan_para;
              
                  // å¦‚æžœæ‰«ææ—¶é—´æœªåˆ°æ¥ï¼Œä¸æ‰§è¡ŒæŒ‰é”®æ‰«æ
                  if (scan_para->cur_scan_times < scan_para->scan_times)
                  {
                      return;
                  }
              
                  scan_para->cur_scan_times = 0; // æ¸…ç©ºæ‰«ææ—¶é—´
              
                  cur_key_value = scan_para->get_value(); // è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„èŽ·å–é”®å€¼å‡½æ•°
              
                  // if (cur_key_value != NO_KEY)
                  //     printf("key id %bu\n", cur_key_value); // æ‰“å°èŽ·å–åˆ°çš„é”®å€¼
              
                  // åˆ¤æ–­æŒ‰é”®æ˜¯å¦æœ‰æ•ˆ
                  if (cur_key_value != NO_KEY)
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        12/05/2025 17:28:59 PAGE 2   

                  {
                      is_key_active = 35; // 35*10Ms
                  }
                  else if (is_key_active)
                  {
                      is_key_active--;
                  }
              
                  // if (cur_key_value != NO_KEY)
                  // {
                  //     //     printf("scan_times %bu\n", scan_para->scan_times);
                  //     //     printf("cur_scan_times %bu\n", scan_para->cur_scan_times);
                  //     //     printf("last_key %bu\n", scan_para->last_key);
                  //     //     printf("filter_value %bu\n", scan_para->filter_value);
                  //     //     printf("filter_cnt %bu\n", scan_para->filter_cnt);
                  //     //     printf("filter_time %bu\n", scan_para->filter_time);
                  //     printf("long_time %bu\n", ad_key_para.long_time);
                  //     printf("long_time %bu\n", (*scan_para).long_time);
                  //     //     printf("hold_time %bu\n", scan_para->hold_time);
                  //     //     printf("press_cnt %bu\n", scan_para->press_cnt);
              
                  //     //     printf("click_cnt %bu\n", scan_para->click_cnt);
                  //     //     printf("click_delay_cnt %bu\n", scan_para->click_delay_cnt);
                  //     //     printf("click_delay_time %bu\n", scan_para->click_delay_time);
                  //     //     printf("notify_value %bu\n", scan_para->notify_value);
                  //     //     printf("key_type %bu\n", scan_para->key_type);
              
                  //     //     printf("latest_key_val %bu\n", scan_para->latest_key_val);
                  //     //     printf("latest_key_event %bu\n", scan_para->latest_key_event);
              
                  //     printf("ad key long time addr %p\n", &ad_key_para.long_time);
                  //     // printf("scan para long time addr %p\n", &(scan_para->long_time));
                  //     printf("scan para long time addr %p\n", (*scan_para).long_time);
                  // }
              
                  //===== æŒ‰é”®æ¶ˆæŠ–å¤„ç†
                  if (cur_key_value != scan_para->filter_value && scan_para->filter_time)
                  {
                      // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼å¦‚æžœä¸ç›¸ç­‰, é‡æ–°æ¶ˆæŠ–å¤„ç†, æ³¨æ„filter_time != 0
             -;
                      scan_para->filter_cnt = 0;               // æ¶ˆæŠ–æ¬¡æ•°æ¸…0, é‡æ–°å¼€å§‹æ¶ˆæŠ–
                      scan_para->filter_value = cur_key_value; // è®°å½•ä¸Šä¸€æ¬¡çš„æŒ‰é”®å€¼
                      return;                                  // ç¬¬ä¸€æ¬¡æ£€æµ‹, è¿”å›žä¸åšå¤„ç†
                  }
              
                  // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼ç›¸ç­‰, filter_cntå¼€å§‹ç´¯åŠ ;
                  if (scan_para->filter_cnt < scan_para->filter_time)
                  {
                      scan_para->filter_cnt++;
                      return;
                  }
              
                  //===== æŒ‰é”®æ¶ˆæŠ–ç»“æŸ, å¼€å§‹åˆ¤æ–­æŒ‰é”®ç±»åž‹(å•å‡», åŒå‡», é•¿æŒ‰, å¤šå‡», HOLD, (é•¿æŒ‰/HOL
             -D)æŠ¬èµ·)
                  if (cur_key_value != scan_para->last_key)
                  {
                      /*
                          å¦‚æžœå½“å‰çš„é”®å€¼ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®æ
             -¾å¼€
                          cur_key = NO_KEY; last_key = valid_key -> æŒ‰é”®è¢«æŠ¬èµ·
                      */
                      // printf("key event up\n");
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        12/05/2025 17:28:59 PAGE 3   

              
                      if (cur_key_value == NO_KEY)
                      {
                          if (scan_para->press_cnt >= scan_para->long_time)
                          { // é•¿æŒ‰/HOLDçŠ¶æ€ä¹‹åŽè¢«æŒ‰é”®æŠ¬èµ·;
                              key_event = KEY_EVENT_UP;
                              key_value = scan_para->last_key;
                              goto _notify; // å‘é€æŠ¬èµ·æ¶ˆæ¯
                              // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY; // è·³è½¬åˆ°å‘é€æŒ‰é”®äº‹ä»¶çš„æ“ä½œ
                          }
              
                          // if (KEY_SCAN_STATUS_NONE == key_scan_status) // å¦‚æžœæ²¡æœ‰ç‰¹æ®Šæ“ä½œ
                          {
                              scan_para->click_delay_cnt = 1; // æŒ‰é”®ç­‰å¾…ä¸‹æ¬¡è¿žå‡»å»¶æ—¶å¼€å§‹
                          }
                      }
                      else
                      {
                          /*
                              å¦‚æžœå½“å‰çš„é”®å€¼ä¸ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜Ž
             -æŒ‰é”®æŒ‰ä¸‹
                              cur_key = valid_key, last_key = NO_KEY -> æŒ‰é”®è¢«æŒ‰ä¸‹
                          */
                          scan_para->press_cnt = 1; // ç”¨äºŽåˆ¤æ–­longå’Œholdäº‹ä»¶çš„è®¡æ•°å™¨é‡æ–°å¼€å§‹è®¡æ—¶;
                          if (cur_key_value != scan_para->notify_value)
                          { // ç¬¬ä¸€æ¬¡å•å‡»/è¿žå‡»æ—¶æŒ‰ä¸‹çš„æ˜¯ä¸åŒæŒ‰é”®, å•å‡»æ¬¡æ•°é‡æ–°å¼€å§‹è®¡æ•°
                              scan_para->click_cnt = 1;
                              scan_para->notify_value = cur_key_value;
                          }
                          else
                          {
                              scan_para->click_cnt++; // å•å‡»æ¬¡æ•°ç´¯åŠ 
                          }
                      }
              
                      goto _scan_end; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
                      // if (KEY_SCAN_STATUS_NONE == key_scan_status)
                      // {
                      //     key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
                      // }
                  }
                  else
                  {
                      /*
                          å¦‚æžœå½“å‰èŽ·å–çš„é”®å€¼ä¸Žä¸Šæ¬¡èŽ·å–çš„é”®å€¼ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®åœ¨é•¿æŒ‰æˆ–æ˜¯æŒ‰é”®æ
             -œªæŒ‰ä¸‹
                          cur_key = last_key -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹/æŒ‰é”®é•¿æŒ‰(HOLD)
                      */
                      if (cur_key_value == NO_KEY)
                      {
                          // last_key = NO_KEY; cur_key = NO_KEY -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
                          if (scan_para->click_cnt > 0)
                          { // æœ‰æŒ‰é”®éœ€è¦æ¶ˆæ¯éœ€è¦å¤„ç†
              
                              // å¦‚æžœåªå“åº”å•å‡»äº‹ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ /ä¿®æ”¹åŠŸèƒ½
              
                              if (scan_para->click_delay_cnt > scan_para->click_delay_time)
                              { // æŒ‰é”®è¢«æŠ¬èµ·åŽå»¶æ—¶åˆ°
                                  // TODO: åœ¨æ­¤å¯ä»¥æ·»åŠ ä»»æ„å¤šå‡»äº‹ä»¶
                                  // if (scan_para->click_cnt >= 5)
                                  // {
                                  //     key_event = KEY_EVENT_FIRTH_CLICK; // äº”å‡»
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        12/05/2025 17:28:59 PAGE 4   

                                  // }
                                  // else if (scan_para->click_cnt >= 4)
                                  // {
                                  //     key_event = KEY_EVENT_FOURTH_CLICK; // 4å‡»
                                  // }
                                  // else if (scan_para->click_cnt >= 3)
                                  // {
                                  //     key_event = KEY_EVENT_TRIPLE_CLICK; // ä¸‰å‡»
                                  // }
                                  // else if (scan_para->click_cnt >= 2)
                                  // if (scan_para->click_cnt >= 2)
                                  // {
                                  //     key_event = KEY_EVENT_DOUBLE_CLICK; // åŒå‡»
                                  // }
                                  // else
                                  {
                                      key_event = KEY_EVENT_CLICK; // å•å‡»
                                      // printf("click \n");
                                  }
                                  key_value = scan_para->notify_value;
              
                                  goto _notify;
                                  // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
                              }
                              else
                              { // æŒ‰é”®æŠ¬èµ·åŽç­‰å¾…ä¸‹æ¬¡å»¶æ—¶æ—¶é—´æœªåˆ°
                                  scan_para->click_delay_cnt++;
                                  goto _scan_end; // æŒ‰é”®æŠ¬èµ·åŽå»¶æ—¶æ—¶é—´æœªåˆ°, è¿”å›ž
                                  // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
                              }
                          }
                          else
                          {
                              goto _scan_end; // æ²¡æœ‰æŒ‰é”®éœ€è¦å¤„ç†
                              // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
                          }
                      }
                      else
                      {
                          // last_key = valid_key; cur_key = valid_key, press_cntç´¯åŠ ç”¨äºŽåˆ¤æ–­longå’Œhold
                          if (scan_para->press_cnt < 255)
                          {
                              scan_para->press_cnt++;
                          }
              
                          // printf("long time %bu\n", scan_para->long_time);
                          // printf("press cnt %bu\n", scan_para->press_cnt);
                          if (scan_para->press_cnt == scan_para->long_time)
                          {
                              key_event = KEY_EVENT_LONG;
              
                              // printf("long time %bu\n", scan_para->long_time);
              
                              // printf("key event long\n");
                          }
                          else if (scan_para->press_cnt == scan_para->hold_time)
                          {
                              key_event = KEY_EVENT_HOLD;
                              scan_para->press_cnt = scan_para->long_time; // ä¸‹ä¸€æ¬¡scan_para->press_cnt++,è¿˜æ˜¯ä¼šè
             -¿›å…¥åˆ°è¿™é‡Œ
                              // printf("key event hold\n");
                          }
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        12/05/2025 17:28:59 PAGE 5   

                          else
                          {
                              goto _scan_end; // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, è¿”å›ž
                              // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
                          }
              
                          // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, å‘æ¶ˆæ¯
                          key_value = cur_key_value;
                          goto _notify;
                          // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
                      }
                  }
              
              _notify:
              
                  // if (KEY_SCAN_STATUS_TO_END_OF_SCAN != key_scan_status)
                  {
                      // if (KEY_TYPE_AD == scan_para->key_type) // å¦‚æžœæ˜¯adæŒ‰é”®
                      {
                          scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
                          scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
              
                          scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
                          scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
              
                          // printf("notify\n");
                      }
                      // else if (KEY_TYPE_TOUCH == scan_para->key_type) // å¦‚æžœæ˜¯è§¦æ‘¸æŒ‰é”®
                      // {
                      //     scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
                      //     scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
              
                      //     scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
                      //     scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
                      // }
                  }
              
              _scan_end:
                  scan_para->last_key = cur_key_value;
                  return;
              #endif
              }
              
              #endif // #if (TOUCH_KEY_ENABLE  || AD_KEY_ENABLE)


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
