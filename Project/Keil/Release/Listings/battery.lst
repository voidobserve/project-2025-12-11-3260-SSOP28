C51 COMPILER V9.60.7.0   BATTERY                                                           12/05/2025 17:29:01 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE BATTERY
OBJECT MODULE PLACED IN .\Release\Objects\battery.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\battery.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X000
                    -C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Relea
                    -se\Listings\battery.lst) OBJECT(.\Release\Objects\battery.obj)

line level    source

   1          #include "battery.h"
   2          
   3          #if BATTERY_SCAN_ENABLE
   4          
   5          volatile u16 battery_scan_time_cnt; // ç”µæ± æ‰«ææ—¶é—´è®¡æ—¶ï¼ˆåœ¨å®šæ—¶å™¨ä¸­ç´¯åŠ ï¼‰
   6          
   7          /**
   8           * @brief å°†adå€¼è½¬æ¢ä¸ºå¯¹åº”çš„ç”µå‹å€¼
   9           *
  10           * @param arg_adc_val é‡‡é›†åˆ°çš„adå€¼
  11           * @return u8 è®¡ç®—å¥½çš„ç”µå‹å€¼ï¼Œå•ä½0.1V
  12           */
  13          u16 conver_adc_val_to_voltage(u16 arg_adc_val)
  14          {
  15   1          /*
  16   1              é‡‡é›†åˆ°çš„adå€¼èŒƒå›´ï¼š0~4095
  17   1              adå€¼å¯¹åº”çš„ç”µå‹ï¼š 0 ~ MAX_VOLTAGE_OF_BATTERY
  18   1              é‚£ä¹ˆ æ¯å•ä½adå€¼å¯¹åº” MAX_VOLTAGE_OF_BATTERY / 4096
  19   1          */
  20   1          // return (u32)arg_adc_val * MAX_VOLTAGE_OF_BATTERY / 4096;
  21   1      
  22   1          // ä½¿ç”¨2.4Vå‚è€ƒç”µå‹ï¼Œ12ä½ç²¾åº¦
  23   1          // ç”µæ± ç”µå‹æ˜¯ 1/11 åˆ†å‹ï¼š
  24   1          return (u32)arg_adc_val * 240 * 11 / 10 / 4096;
  25   1      }
  26          
  27          // å°†ç”µæ± ç”µå‹è½¬æ¢ä¸ºå¯¹åº”çš„ç™¾åˆ†æ¯”
  28          // voltageï¼š 0~255 ï¼Œ å¯¹åº”0~25.5V
  29          // ä¾‹å¦‚ voltage == 140ï¼Œå¯¹åº”14.0V
  30          u8 conver_voltage_of_battery_to_percentage(u8 voltage)
  31          {
  32   1          u8 tmp;
  33   1      
  34   1          // å®¢æˆ·è¦æ±‚ï¼Œå¦‚æœæ£€æµ‹åˆ°å¤§äº15Vï¼Œå°±è®¤ä¸ºæ»¡ç”µ
  35   1          if (voltage >= 150)
  36   1          {
  37   2              tmp = 100;
  38   2          }
  39   1          else
  40   1          {
  41   2              // å¦‚æœç”µå‹å°äº15Vï¼Œæ ¹æ®å…¬å¼æ¥å¾—åˆ°ç™¾åˆ†æ¯”
  42   2              // ç”¨ç”µæ± ç”µå‹voltageé™¤ä»¥MAX_VOLTAGE_OF_BATTERYï¼Œå¾—åˆ°å æ¯”ï¼Œå†ä¹˜ä»¥100ï¼Œå¾—åˆ°ç™¾åˆ†
             -æ¯”
  43   2              tmp = (u16)voltage * 100 / MAX_VOLTAGE_OF_BATTERY;
  44   2          }
  45   1      
  46   1          return tmp;
  47   1      }
  48          
  49          void battery_scan(void)
  50          {
  51   1          u16 voltage_of_battery = 0;       // å­˜æ”¾ç”µæ± ç”µå‹
  52   1          u8 cur_percentage_of_battery = 0; // å­˜æ”¾å½“å‰ç”µæ± ç”µé‡ç™¾åˆ†æ¯”
C51 COMPILER V9.60.7.0   BATTERY                                                           12/05/2025 17:29:01 PAGE 2   

  53   1      
  54   1          static volatile u32 battery_scan_cnt; // è®°å½•ç”µæ± ç”µå‹æ‰«ææ¬¡æ•°
  55   1          static volatile u32 battery_val;      // ç´¯åŠ æ¯æ¬¡é‡‡é›†åˆ°çš„adå€¼ï¼Œåˆ°äº†ç”µæ± æ‰«ææ—¶é—´æ—¶ï¼
             -Œç›´æ¥æ±‚å¹³å‡å€¼
  56   1      
  57   1          static bit flag_is_power_on_first = 1; // æ˜¯å¦ç¬¬ä¸€æ¬¡ä¸Šç”µ
  58   1      
  59   1      #if 1
  60   1          adc_sel_pin(ADC_PIN_BATTERY);
  61   1          battery_val += adc_getval(); // å¯èƒ½è¦é˜²æ­¢è®¡æ•°æº¢å‡º
  62   1          battery_scan_cnt++;          // ä¸Šé¢é‡‡é›†åˆ°ä¸€æ¬¡adå€¼ä¹‹åï¼Œè¿™é‡ŒåŠ ä¸€è¡¨ç¤ºé‡‡é›†äº†ä¸€æ¬¡
  63   1      
  64   1          if (flag_is_power_on_first)
  65   1          {
  66   2              // ç¬¬ä¸€æ¬¡ä¸Šç”µ
  67   2              battery_val /= battery_scan_cnt; // å–å¹³å‡æ•°
  68   2              voltage_of_battery = conver_adc_val_to_voltage(battery_val);
  69   2              cur_percentage_of_battery = conver_voltage_of_battery_to_percentage(voltage_of_battery);
  70   2              battery_val = 0;           // æ¸…ç©ºæ•°å€¼
  71   2              battery_scan_cnt = 0;      // æ¸…ç©ºè®¡æ•°å€¼
  72   2              battery_scan_time_cnt = 0; // æ¸…ç©ºæ—¶é—´è®¡æ•°å€¼
  73   2      
  74   2              fun_info.battery = cur_percentage_of_battery;
  75   2              fun_info.voltage_of_battery = voltage_of_battery;
  76   2      
  77   2              // printf("cur voltage of battery : %bu\n", voltage_of_battery);
  78   2              // printf("cur percent of battery : %bu\n", cur_percentage_of_battery);
  79   2      
  80   2              flag_get_voltage_of_battery = 1;
  81   2              flag_get_battery = 1;
  82   2      
  83   2              flag_is_power_on_first = 0;
  84   2          }
  85   1          else
  86   1          {
  87   2              // ä¸æ˜¯ç¬¬ä¸€æ¬¡ä¸Šç”µ
  88   2      
  89   2              if (battery_scan_time_cnt >= BATTERY_SCAN_UPDATE_TIME_MS) // å¦‚æœåˆ°äº†ç”µæ± æ•°æ®çš„æ›´æ–°æ—¶é
             -—´ï¼ˆæ›´æ–°/å‘é€ç”µæ± æ•°æ®çš„æ—¶é—´ï¼‰
  90   2              {
  91   3                  battery_val /= battery_scan_cnt; // å–å¹³å‡æ•°
  92   3                  voltage_of_battery = conver_adc_val_to_voltage(battery_val);
  93   3                  cur_percentage_of_battery = conver_voltage_of_battery_to_percentage(voltage_of_battery);
  94   3                  battery_val = 0;           // æ¸…ç©ºæ•°å€¼
  95   3                  battery_scan_cnt = 0;      // æ¸…ç©ºè®¡æ•°å€¼
  96   3                  battery_scan_time_cnt = 0; // æ¸…ç©ºæ—¶é—´è®¡æ•°å€¼
  97   3      
  98   3                  fun_info.battery = cur_percentage_of_battery;
  99   3                  fun_info.voltage_of_battery = voltage_of_battery;
 100   3      
 101   3                  // printf("cur voltage of battery : %bu\n", voltage_of_battery);
 102   3                  // printf("cur percent of battery : %bu\n", cur_percentage_of_battery);
 103   3      
 104   3                  flag_get_voltage_of_battery = 1;
 105   3                  flag_get_battery = 1;
 106   3              }
 107   2          }
 108   1      
 109   1      #endif
 110   1      
 111   1      #if 0
                  adc_sel_pin(ADC_PIN_BATTERY);
C51 COMPILER V9.60.7.0   BATTERY                                                           12/05/2025 17:29:01 PAGE 3   

                  // battery_val += adc_getval(); // å¯èƒ½è¦é˜²æ­¢è®¡æ•°æº¢å‡º
                  // battery_scan_cnt++; // ä¸Šé¢é‡‡é›†åˆ°ä¸€æ¬¡adå€¼ä¹‹åï¼Œè¿™é‡ŒåŠ ä¸€è¡¨ç¤ºé‡‡é›†äº†ä¸€æ¬¡
                  if (battery_scan_time_cnt >= BATTERY_SCAN_UPDATE_TIME_MS) // å¦‚æœåˆ°äº†ç”µæ± æ•°æ®çš„æ›´æ–°æ—¶é—´ï¼
             -ˆæ›´æ–°/å‘é€ç”µæ± æ•°æ®çš„æ—¶é—´ï¼‰
                  {
                      // battery_val /= battery_scan_cnt; // å–å¹³å‡æ•°
                      // battery_val = adc_getval();
                      battery_val = adc_single_convert();
                      voltage_of_battery = conver_adc_val_to_voltage(battery_val);
                      cur_percentage_of_battery = conver_voltage_of_battery_to_percentage(voltage_of_battery);
                      battery_val = 0;           // æ¸…ç©ºæ•°å€¼
                      battery_scan_cnt = 0;      // æ¸…ç©ºè®¡æ•°å€¼
                      battery_scan_time_cnt = 0; // æ¸…ç©ºæ—¶é—´è®¡æ•°å€¼
              
                      fun_info.battery = cur_percentage_of_battery;
                      fun_info.voltage_of_battery = voltage_of_battery;
              
                      // printf("cur voltage of battery : %bu\n", voltage_of_battery);
                      // printf("cur percent of battery : %bu\n", cur_percentage_of_battery);
              
                      flag_get_voltage_of_battery = 1;
                      flag_get_battery = 1;
                  }
              #endif
 136   1      }
 137          
 138          #endif // BATTERY_SCAN_ENABLE


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    296    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     10       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
