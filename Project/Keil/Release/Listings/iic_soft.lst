C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE IIC_SOFT
OBJECT MODULE PLACED IN .\Release\Objects\iic_soft.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\iic_soft.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(
                    -0X000C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\
                    -Release\Listings\iic_soft.lst) OBJECT(.\Release\Objects\iic_soft.obj)

line level    source

   1          #include "iic_soft.h"
   2          
   3          #if USE_EEPROM_SAVE_DATA
              
              volatile eeprom_menu_t eeprom_menu_prev;
              volatile eeprom_menu_t eeprom_menu_next;
              volatile eeprom_saveinfo_t eeprom_saveinfo;
              
              // æ›´æ–°eepromä¸­ç›®å½•ç›¸å…³çš„æ•°æ®ï¼Œéœ€è¦æå‰å†™å¥½ eeprom_menu_prev å’Œ eeprom_menu_next
              void eeprom_menu_write(void)
              {
                  eeprom_24cxx_write(0, (u8 *)&eeprom_menu_prev, sizeof(eeprom_menu_t));
                  WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
                  eeprom_24cxx_write(1, (u8 *)&eeprom_menu_next, sizeof(eeprom_menu_t));
              }
              
              void eeprom_menu_read(void)
              {
                  eeprom_24cxx_read(0, (u8 *)&eeprom_menu_prev, sizeof(eeprom_menu_t));
                  WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
                  eeprom_24cxx_read(1, (u8 *)&eeprom_menu_next, sizeof(eeprom_menu_t));
              }
              
              void eeprom_menu_init(void)
              {
                  eeprom_menu_read();
              
                  if (eeprom_menu_prev.is_data_valid != EEPROM_DATA_VALID_VAL && eeprom_menu_next.is_data_valid != EEPRO
             -M_DATA_VALID_VAL)
                  {
                      // å¦‚æœä¸¤ä¸ªé¡µ çš„ç›®å½•è¯»åˆ°çš„æ•°æ®éƒ½æ˜¯æ— æ•ˆçš„ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨eepromï¼Œè¿›è
             -¡Œåˆå§‹åŒ–
                      eeprom_menu_prev.cur_write_page_id = 2; // 0ä¸ºç›®å½•prevï¼Œ1ä¸ºç›®å½•nextï¼ŒçœŸæ­£çš„æ•°æ®ä»2å¼
             -€å§‹
                      eeprom_menu_prev.is_data_valid = EEPROM_DATA_VALID_VAL;
              
                      eeprom_menu_next = eeprom_menu_prev;
                      eeprom_menu_write();
              
                      // printf("all menus are invalid\n");
                  }
                  else if ((eeprom_menu_prev.is_data_valid == EEPROM_DATA_VALID_VAL && eeprom_menu_next.is_data_valid !=
             - EEPROM_DATA_VALID_VAL) ||
                           (eeprom_menu_prev.is_data_valid != EEPROM_DATA_VALID_VAL && eeprom_menu_next.is_data_valid ==
             - EEPROM_DATA_VALID_VAL))
                  {
                      // å¦‚æœä¸¤ä¸ªé¡µçš„ç›®å½•è¯»åˆ°çš„æ•°æ®æœ‰ä¸€ä¸ªé¡µæ˜¯æœ‰æ•ˆçš„ï¼Œæœ‰ä¸€ä¸ªé¡µæ˜¯æ— æ•ˆçš„
                      // ç”¨æœ‰æ•ˆçš„é‚£ä¸ªé¡µçš„æ•°æ®è¿›è¡Œåˆå§‹åŒ–
              
                      if (eeprom_menu_prev.is_data_valid == EEPROM_DATA_VALID_VAL)
                      {
                          eeprom_menu_next = eeprom_menu_prev;
                          eeprom_24cxx_write(1, (u8 *)&eeprom_menu_next, sizeof(eeprom_menu_t));
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 2   

                      }
                      else if (eeprom_menu_next.is_data_valid == EEPROM_DATA_VALID_VAL)
                      {
                          eeprom_menu_prev = eeprom_menu_next;
                          eeprom_24cxx_write(0, (u8 *)&eeprom_menu_prev, sizeof(eeprom_menu_t));
                      }
              
                      // printf("one of menus is valid\n");
                  }
                  else
                  {
                      // å¦‚æœä¸¤ä¸ªé¡µçš„ç›®å½•ä¸­çš„æ•°æ®éƒ½æœ‰æ•ˆ
                      // printf("menus are valid\n");
              
                      /*
                          åˆ¤æ–­ç›®å½•ä¸­ cur_write_page_id å½“å‰è¦å†™å…¥é‡Œç¨‹æ•°æ®çš„é¡µé¢ç¼–å·æ˜¯å¦ä¸€è‡´ï¼Œ
                          å¦‚æœä¸ä¸€è‡´ï¼Œä»¥æœ€å¤§çš„idä½œä¸ºæœ€æ–°çš„é¡µé¢ç¼–å·ï¼Œå†å†™å›eeprom
                      */
                      if (eeprom_menu_prev.cur_write_page_id > eeprom_menu_next.cur_write_page_id)
                      {
                          eeprom_menu_next.cur_write_page_id = eeprom_menu_prev.cur_write_page_id;
                          eeprom_menu_write();
                      }
                      else if (eeprom_menu_prev.cur_write_page_id < eeprom_menu_next.cur_write_page_id)
                      {
                          eeprom_menu_prev.cur_write_page_id = eeprom_menu_next.cur_write_page_id;
                          eeprom_menu_write();
                      }
                      else // (eeprom_menu_prev.cur_write_page_id == eeprom_menu_next.cur_write_page_id)
                      {
                          // æ•°æ®ä¸€è‡´
                      }
                  }
              }
              
              #if USE_MY_DEBUG
              volatile bit flag_is_printf_eeprom_data;
              
              volatile eeprom_menu_t eeprom_menu;
              
              void eeprom_printf_all(void)
              {
                  u16 i;
              
                  // eeprom_menu_t eeprom_menu = {0};
                  eeprom_menu.cur_write_page_id = 0;
                  eeprom_menu.is_data_valid = 0;
                  eeprom_24cxx_read(0, (u8 *)&eeprom_menu, sizeof(eeprom_menu_t));
                  printf("eeprom_menu_prev.cur_write_page_id = %bu\n", eeprom_menu.cur_write_page_id);
                  printf("eeprom_menu_prev.is_data_valid = 0x %x\n", (u16)eeprom_menu.is_data_valid);
              
                  eeprom_menu.cur_write_page_id = 0;
                  eeprom_menu.is_data_valid = 0;
                  eeprom_24cxx_read(1, (u8 *)&eeprom_menu, sizeof(eeprom_menu_t));
                  printf("eeprom_menu_next.cur_write_page_id = %bu\n", eeprom_menu.cur_write_page_id);
                  printf("eeprom_menu_next.is_data_valid = 0x %x\n", (u16)eeprom_menu.is_data_valid);
              
                  printf("====================================================\n");
              
                  // for (i = 2; i < 128; i++)
                  // for (i = 2; i < EEPROM_PAGE_NUMS; i++)
                  for (i = 2; i < 10; i++)
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 3   

                  {
                      eeprom_24cxx_read(i, (u8 *)&eeprom_saveinfo, sizeof(eeprom_saveinfo_t));
                      printf("cur_page_id %u\n", i);
                      printf("eeprom_saveinfo.erase_cnt = %lu\n", eeprom_saveinfo.erase_cnt);
                      printf("eeprom_saveinfo.toal_mileage = %lu\n", eeprom_saveinfo.total_mileage);
                      printf("eeprom_saveinfo.subtotal_mileage = %lu\n", eeprom_saveinfo.subtotal_mileage);
                      printf("eeprom_saveinfo.subtotal_mileage_2 = %lu\n", eeprom_saveinfo.subtotal_mileage_2);
                      printf("====================================================\n");
                      WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
                  }
              }
              
              #endif
              
              void eeprom_24cxx_clear(void)
              {
                  u16 i;
                  // const u8 clear_data = 0x00; // è¦å¡«å……çš„æ•°æ® 
                  const u8 clear_data = 0xFF; // è¦å¡«å……çš„æ•°æ® 
                  for (i = 0; i < ((u16)128 * 32); i++)
                  {
                      while (iic_eeprom_write(i, (u8 *)&clear_data, 1))
                      {
                          WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
                      }
                  }
              }
              
              // å‘eepromå†™å…¥éœ€è¦ä¿å­˜çš„æ•°æ®
              volatile eeprom_saveinfo_t eeprom_saveinfo_prev; // å­˜æ”¾ä»eepromè¯»å‡ºçš„æ•°æ®ï¼Œprevï¼ŒåŒä¸€ç»„æ•°æ
             -®çš„å‰ä¸€é¡µæ•°æ®
              volatile eeprom_saveinfo_t eeprom_saveinfo_next; // å­˜æ”¾ä»eepromè¯»å‡ºçš„æ•°æ®ï¼Œnextï¼ŒåŒä¸€ç»„æ•°æ
             -®çš„åä¸€é¡µæ•°æ®
              /*
                  å‡½æ•°å†…éƒ¨ä¼šæŠŠ fun_info.save_info çš„æ•°æ®å†™å…¥eeprom
              */
              void eeprom_data_save(void)
              {
                  u8 cur_save_info_id_prev; // å½“å‰ä¿å­˜æ•°æ®çš„é¡µidï¼Œprevï¼ŒåŒä¸€ç»„æ•°æ®çš„å‰ä¸€é¡µï¼ˆä¸ºäº†è
             -Š‚çœç¨‹åºç©ºé—´ï¼Œä¸è¿›è¡Œåˆå§‹åŒ–ï¼Œç”±å‡½æ•°å†…éƒ¨èµ‹å€¼ï¼‰
                  u8 cur_save_info_id_next; // å½“å‰ä¿å­˜æ•°æ®çš„é¡µidï¼Œnextï¼ŒåŒä¸€ç»„æ•°æ®çš„åä¸€é¡µ
              
                  u8 cur_write_page_id = 0; // å­˜æ”¾å¾…å†™å…¥æ•°æ®çš„åœ°å€å¯¹åº”id
                  u32 cur_erase_cnt;        // å­˜æ”¾è¯»å–åˆ°çš„æ“¦å†™æ¬¡æ•°
              
                  /*
                      å†™å…¥å‰ï¼Œè¯»å–ç›®å½•ï¼Œæ ¹æ®ç›®å½•æ‰¾åˆ°è¦å†™å…¥çš„åœ°å€
              
                      å¦‚æœç›®å½•çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä»¥æœ€åå†™å…¥çš„åœ°å€ä½œä¸ºæ–°å†™å…¥åœ°å€ï¼ˆç›®å½•ä¸­çš„ä¸¤ä¸
             -ªåœ°å€ï¼Œæœ€åå†™å…¥çš„åœ°å€åº”è¯¥å¤§äºå¦ä¸€ä¸ªåœ°å€ï¼‰
                  */
              
                  eeprom_menu_read();
              
                  // if (eeprom_menu_prev.is_data_valid == EEPROM_DATA_VALID_VAL && eeprom_menu_next.is_data_valid == EE
             -PROM_DATA_VALID_VAL)
                  if (eeprom_menu_prev.cur_write_page_id == eeprom_menu_next.cur_write_page_id)
                  {
                      cur_write_page_id = eeprom_menu_prev.cur_write_page_id;
                  }
                  else
                  {
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 4   

                      // å¦‚æœç›®å½•ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼Œåˆ¤æ–­å“ªä¸ªåœ°å€æ›´å¤§ï¼Œå“ªä¸ªå°±ä½œä¸ºå¾…å†™å…¥çš„åœ°å
             -€çš„id
                      if (eeprom_menu_prev.cur_write_page_id > eeprom_menu_next.cur_write_page_id)
                      {
                          cur_write_page_id = eeprom_menu_prev.cur_write_page_id;
                      }
                      else
                      {
                          cur_write_page_id = eeprom_menu_next.cur_write_page_id;
                      }
                  }
              
                  /*
                      page[0]å’Œpage[1]å·²ç»ä½œä¸ºç›®å½•ä½¿ç”¨ï¼ˆid==0å’Œid==1ï¼‰ï¼Œ
                      å‰©ä¸‹çš„é¡µé¢ï¼Œæ¯ä¸¤ä¸ªé¡µé¢ä½œä¸ºä¸€ç»„æ•°æ®ï¼Œ
                      é‚£ä¹ˆå¶æ•°é¡µé¢ä½œä¸ºåŒä¸€ç»„é¡µé¢çš„å‰ä¸€ä¸ªé¡µé¢ï¼Œå¥‡æ•°é¡µé¢ä½œä¸ºåŒä¸€ç»„é¡µé¢çš„å
             -ä¸€ä¸ªé¡µé¢
              
                      ä¾‹å¦‚ id == 2 ä½œä¸ºç¬¬ 1 ç»„é¡µé¢çš„å‰ä¸€ä¸ªé¡µé¢ prevï¼Œ
                          id == 3 ä½œä¸ºç¬¬ 1 ç»„é¡µé¢çš„åä¸€ä¸ªé¡µé¢ next
                  */
                  if (cur_write_page_id % 2 == 0)
                  {
                      /*
                          å¦‚æœå¾—åˆ°çš„æ˜¯å¶æ•°é¡µé¢ï¼Œ
                          å¾—åˆ°çš„å¶æ•°ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬ä¸€ä¸ªé¡µé¢ prev
                          å¾—åˆ°çš„å¶æ•° + 1ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬äºŒä¸ªé¡µé¢ next
                      */
                      cur_save_info_id_prev = cur_write_page_id;
                      cur_save_info_id_next = cur_write_page_id + 1;
                  }
                  else
                  {
                      /*
                          å¦‚æœå¾—åˆ°çš„æ˜¯å¥‡æ•°é¡µé¢ï¼Œ
              
                          å¾—åˆ°çš„å¥‡æ•° - 1ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬ä¸€ä¸ªé¡µé¢ prev
                          å¾—åˆ°çš„å¥‡æ•°ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬äºŒä¸ªé¡µé¢ next
                      */
                      cur_save_info_id_prev = cur_write_page_id - 1;
                      cur_save_info_id_next = cur_write_page_id;
                  }
              
                  /*
                      å¾—åˆ°åŒä¸€ç»„é¡µé¢çš„å‰ã€åä¸¤ä¸ªé¡µé¢çš„idåï¼Œè¯»å–è¿™ä¸¤ä¸ªé¡µé¢å¯¹åº”çš„æ•°æ®
              
                      å°†ä¸¤ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œ ç”¨æ€»é‡Œç¨‹è¾ƒå¤§çš„æ•°æ® è¦†ç›– æ€»é‡Œç¨‹è¾ƒå°çš„æ•°æ
             -®
              
                      å¦‚æœè¶…è¿‡äº†é™åˆ¶çš„æ“¦å†™æ¬¡æ•°ï¼Œè¦æ¢ä¸‹ä¸€ç»„é¡µé¢ï¼Œå¹¶ä¸”æ›´æ–°åˆ°ç›®å½•ä¸­
                      å¦‚æœå†™å®Œä¹‹åï¼Œè®°å½•çš„é¡µé¢idä¸ç›®å½•ä¸­çš„idä¸ä¸€è‡´ï¼Œè¦æ›´æ–°ç›®å½•ä¸­è®°å½•çš„é¡µé
             -¢id
                  */
                  eeprom_24cxx_read((cur_save_info_id_prev), (u8 *)&eeprom_saveinfo_prev, sizeof(eeprom_saveinfo_t));
                  eeprom_24cxx_read((cur_save_info_id_next), (u8 *)&eeprom_saveinfo_next, sizeof(eeprom_saveinfo_t));
              
                  // æ•°æ®æ— æ•ˆï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è¯»å–ï¼Œæˆ–è€…ç”±äºå†™å…¥æ—¶æ‰ç”µå¯¼è‡´æ•°æ®ä¸¢å¤±
                  if (eeprom_saveinfo_prev.is_data_valid != EEPROM_DATA_VALID_VAL)
                  {
                      eeprom_saveinfo_prev.erase_cnt = 0;
                      eeprom_saveinfo_prev.total_mileage = 0;
                      eeprom_saveinfo_prev.subtotal_mileage = 0;
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 5   

                      eeprom_saveinfo_prev.subtotal_mileage_2 = 0;
                      eeprom_saveinfo_prev.is_data_valid = EEPROM_DATA_VALID_VAL;
                  }
              
                  // æ•°æ®æ— æ•ˆï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è¯»å–ï¼Œæˆ–è€…ç”±äºå†™å…¥æ—¶æ‰ç”µå¯¼è‡´æ•°æ®ä¸¢å¤±
                  if (eeprom_saveinfo_next.is_data_valid != EEPROM_DATA_VALID_VAL)
                  {
                      eeprom_saveinfo_next = eeprom_saveinfo_prev;
                  }
              
                  if (eeprom_saveinfo_prev.total_mileage < eeprom_saveinfo_next.total_mileage)
                  {
                      /*
                          å¦‚æœå‰ä¸€ä¸ªé¡µé¢çš„æ€»é‡Œç¨‹è¦å°äºåä¸€ä¸ªé¡µé¢çš„æ€»é‡Œç¨‹ï¼Œ
                          åä¸€ä¸ªé¡µé¢çš„æ€»é‡Œç¨‹ åŠ ä¸Š æ–°å¢çš„æ€»é‡Œç¨‹å¢é‡ï¼Œå¾—åˆ°çš„æ€»é‡Œç¨‹ä¿å­˜åˆ°å‰ä¸
             -€ä¸ªé¡µé¢ä¸­ï¼Œ
                          åä¸€ä¸ªé¡µé¢ä½œä¸ºå¤‡ä»½ï¼Œä¹Ÿä¿å­˜ä¸‹æ¥
                      */
                      eeprom_saveinfo_next.total_mileage = fun_info.save_info.total_mileage;
                      eeprom_saveinfo_next.subtotal_mileage = fun_info.save_info.subtotal_mileage;
                      eeprom_saveinfo_next.subtotal_mileage_2 = fun_info.save_info.subtotal_mileage_2;
              
                      cur_erase_cnt = eeprom_saveinfo_next.erase_cnt; // å­˜æ”¾æ“¦å†™æ¬¡æ•°
                      eeprom_saveinfo_prev = eeprom_saveinfo_next;
                  }
                  else
                  {
                      /*
                          å¦‚æœå‰ä¸€ä¸ªé¡µé¢çš„æ€»é‡Œç¨‹è¦ å¤§äºæˆ–ç­‰äº åä¸€ä¸ªé¡µé¢çš„æ€»é‡Œç¨‹ï¼Œ
                          å‰ä¸€ä¸ªé¡µé¢çš„æ€»é‡Œç¨‹ åŠ ä¸Š æ–°å¢çš„æ€»é‡Œç¨‹å¢é‡ï¼Œå¾—åˆ°çš„æ€»é‡Œç¨‹ä¿å­˜åˆ°åä¸
             -€ä¸ªé¡µé¢ä¸­ï¼Œ
                          å‰ä¸€ä¸ªé¡µé¢ä½œä¸ºå¤‡ä»½ï¼Œä¹Ÿä¿å­˜ä¸‹æ¥
                      */
              
                      eeprom_saveinfo_prev.total_mileage = fun_info.save_info.total_mileage;
                      eeprom_saveinfo_prev.subtotal_mileage = fun_info.save_info.subtotal_mileage;
                      eeprom_saveinfo_prev.subtotal_mileage_2 = fun_info.save_info.subtotal_mileage_2;
              
                      cur_erase_cnt = eeprom_saveinfo_prev.erase_cnt; // å­˜æ”¾æ“¦å†™æ¬¡æ•°
                      eeprom_saveinfo_next = eeprom_saveinfo_prev;
                  }
              
                  cur_erase_cnt++; // æ“¦å†™æ¬¡æ•°ç´¯åŠ 
                  eeprom_saveinfo_prev.erase_cnt = cur_erase_cnt;
                  eeprom_saveinfo_next.erase_cnt = cur_erase_cnt;
                  if (cur_erase_cnt > EEPROM_MAX_ERASE_COUNTS_PER_PAGE)
                  {
                      // å¦‚æœè¶…è¿‡äº†ä¸€ç»„é¡µé¢çš„æœ€å¤§æ“¦å†™æ¬¡æ•°ï¼Œæ›´æ¢ä¸‹ä¸€ç»„é¡µé¢
              
                      cur_save_info_id_prev = cur_save_info_id_next + 1; // å½“å‰ä¸ºå¥‡æ•°idï¼ŒåŠ ä¸€ï¼Œä¸ºå¶æ•°idï¼Œæ
             -˜¯ä¸‹ä¸€ç»„é¡µé¢çš„ç¬¬ä¸€ä¸ªé¡µé¢
                      cur_save_info_id_next = cur_save_info_id_prev + 1;
              
                      if (cur_save_info_id_prev >= (EEPROM_PAGE_NUMS - 2))
                      {
                          // é˜²æ­¢ç›®å½•å’Œæ“¦å†™çš„ä½ç½®è¶Šç•Œï¼Œè¶…å‡ºäº†eepromèƒ½å­˜æ”¾çš„ä½ç½®
                          cur_save_info_id_prev = EEPROM_PAGE_NUMS - 2; // eepromçš„å€’æ•°ç¬¬2é¡µ
                          cur_save_info_id_next = EEPROM_PAGE_NUMS - 1; // eepromçš„å€’æ•°ç¬¬1é¡µï¼Œæœ€åä¸€é¡µ
                      }
              
                      // æ“¦å†™æ¬¡æ•°æ¸…é›¶
                      eeprom_saveinfo_prev.erase_cnt = 0;
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 6   

                      eeprom_saveinfo_next.erase_cnt = 0;
                  }
              
                  eeprom_24cxx_write(cur_save_info_id_prev, (u8 *)&eeprom_saveinfo_prev, sizeof(eeprom_saveinfo_t));
                  eeprom_24cxx_write(cur_save_info_id_next, (u8 *)&eeprom_saveinfo_next, sizeof(eeprom_saveinfo_t));
              
                  /*
                      å¦‚æœå†™å…¥çš„é¡µé¢idä¸ç›®å½•è®°å½•çš„idä¸ä¸€æ ·ï¼Œåˆ™æ›´æ–°ç›®å½•è®°å½•çš„id
                  */
                  if (cur_save_info_id_prev != eeprom_menu_prev.cur_write_page_id)
                  {
                      eeprom_menu_prev.cur_write_page_id = cur_save_info_id_prev;
                      eeprom_menu_prev.is_data_valid = EEPROM_DATA_VALID_VAL;
              
                      // eeprom_menu_next.cur_write_page_id = cur_save_info_id_prev;
                      // eeprom_menu_next.is_data_valid = EEPROM_DATA_VALID_VAL;
              
                      eeprom_menu_next = eeprom_menu_prev;
              
                      eeprom_menu_write();
                  }
              }
              
              // static void delay_5us(u32 us)
              // {
              //     u32 b = us * 1;
              //     // u32 b = us * 2;
              //     while (b--)
              //     {
              //     }
              // }
              
              /**
               * @brief  iic start function
               * @param  None
               * @retval None
               */
              void iic_start(void)
              {
                  // èµ·å§‹æ—¶ï¼Œç³»ç»Ÿæ—¶é’Ÿçº¿ï¼ˆSCLKï¼‰å’Œç³»ç»Ÿæ•°æ®çº¿ï¼ˆSDATAï¼‰éƒ½å¤„äºé«˜ç”µå¹³
                  SDA_OUT(); // SDAçº¿è¾“å‡º
                  IIC_SDA = 1;
                  IIC_SCL = 1;
                  // å»¶æ—¶å‡½æ•°æ˜¯ä¸ºäº†ç­‰å¾…é…ç½®å®Œæˆï¼Œå½“SCLKä¸ºé«˜ç”µå¹³æ—¶ï¼ŒSDATAè·³å˜ä¸ºä½ç”µå¹³
                  // ç´§æ¥ç€SCLKä¹Ÿè·³å˜ä¸ºä½ç”µå¹³
                  // äº§ç”Ÿä¸€ä¸ªèµ·å§‹ä¿¡å·
                  IIC_DELAY();
                  IIC_SDA = 0; // START:when CLK is high,DATA change form high to low
                  IIC_DELAY();
                  IIC_SCL = 0;
              }
              
              /**
               * @brief  iic stop function
               * @param  None
               * @retval None
               */
              void iic_stop(void)
              {
                  SDA_OUT(); // SDAçº¿è¾“å‡º
              
                  // é…ç½®æ—¶é’Ÿçº¿å’Œæ•°æ®çº¿å‡ä¸ºä½ç”µå¹³
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 7   

                  IIC_SCL = 0;
                  IIC_SDA = 0; // STOP:when CLK is high DATA change form low to high
                  IIC_DELAY();
              
                  // é…ç½®æ—¶é’Ÿçº¿ä¸ºé«˜ç”µå¹³
                  IIC_SCL = 1;
                  IIC_DELAY();
              
                  // åœ¨æ—¶é’Ÿçº¿ä¸ºé«˜ç”µå¹³æ—¶ï¼Œè¾“å‡ºçš„æ•°æ®çº¿ä»ä½ç”µå¹³è·³å˜åˆ°é«˜ç”µå¹³ï¼Œåˆ™äº§ç”Ÿäº†åœæ­¢
             -ä¿¡å·
                  IIC_SDA = 1;
                  IIC_DELAY();
              }
              
              /**
               * @brief  wait ack function
               * @param  None
               * @retval 1:no ack 0:ack
               */
              u8 iic_wait_ack(void)
              {
                  u8 timeout = 0;
              
                  SDA_IN(); // SDAè®¾ç½®ä¸ºè¾“å…¥
              
                  // é…ç½®ä¸ºé«˜ç”µå¹³
                  IIC_SDA = 1;
                  IIC_DELAY();
              
                  // é…ç½®ä¸ºé«˜ç”µå¹³
                  IIC_SCL = 1;
                  IIC_DELAY();
              
                  while (IIC_SDA)
                  {
                      // ç­‰å¾…SDAæ‹‰ä½ï¼Œè¡¨ç¤ºåº”ç­”å¸¦æ¥ï¼Œä¸ç„¶ä¸€ç›´whileå¾ªç¯ï¼Œç›´åˆ°è¶…æ—¶
                      timeout++;
                      if (timeout > 250)
                      {
                          iic_stop(); // ç­‰å¾…è¶…æ—¶ï¼Œåº”ç­”å¤±è´¥ï¼Œå‘å‡ºåœæ­¢ä¿¡å·
                          return 1;   // è¿”å›1ï¼Œè¡¨ç¤ºå¤±è´¥
                      }
                      IIC_DELAY();
                  }
                  IIC_SCL = 0; // SCLæ‹‰ä½
              
                  return 0; // è¿”å›0ï¼Œè¡¨ç¤ºæˆåŠŸ
              }
              
              /**
               * @brief  iic ack function
               * @param  None
               * @retval None
               */
              void iic_ack(void)
              {
                  IIC_SCL = 0;
                  SDA_OUT();
                  IIC_SDA = 0;
                  IIC_DELAY();
                  IIC_SCL = 1;
                  IIC_DELAY();
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 8   

                  IIC_SCL = 0;
              }
              
              /**
               * @brief  iic no ack function
               * @param  None
               * @retval None
               */
              void iic_nack(void)
              {
                  IIC_SCL = 0;
                  SDA_OUT();
                  IIC_SDA = 1;
                  IIC_DELAY();
                  IIC_SCL = 1;
                  IIC_DELAY();
                  IIC_SCL = 0;
              }
              
              /**
               * @brief  iic send 1 byte data function
               * @param  None
               * @retval 1:Ack 0:No Ack
               */
              void iic_send_byte(u8 txd)
              {
                  u8 i;
              
                  // é…ç½®P03ä¸ºè¾“å‡ºæ¨¡å¼
                  SDA_OUT(); // SDAçº¿è¾“å‡ºæ¨¡å¼
              
                  // åªæœ‰åœ¨æ—¶é’Ÿçº¿ä¸º0çš„æƒ…å†µä¸‹ï¼Œæ•°æ®çº¿æ‰å¯ä»¥è¿›è¡Œé«˜ä½ç”µå¹³çš„è·³å˜
                  IIC_SCL = 0; // æ‹‰ä½æ—¶é’Ÿå¼€å§‹æ•°æ®ä¼ è¾“
              
                  for (i = 0; i < 8; i++)
                  {                                // forå¾ªç¯ï¼Œä¸€ä½ä¸€ä½çš„å‘é€ï¼Œä»æœ€é«˜ä½ ä½7å¼€å§‹
                      IIC_SDA = (txd & 0x80) >> 7; // é™¤äº†ä½7å¤–ï¼Œå…¶ä½™å…¨å±è”½ä¸º0ï¼Œç„¶åå³ç§»åˆ°ä½0ï¼Œç»™SDA
             -æ•°æ®çº¿
                      txd <<= 1;                   // å·¦ç§»ä¸€ä½ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡å‘é€
                      IIC_DELAY();
              
                      // å‘é€å®Œæˆä¹‹åï¼Œæ—¶é’Ÿçº¿æ‹‰é«˜
                      IIC_SCL = 1;
                      IIC_DELAY();
              
                      // ç´§æ¥ç€æ‹‰ä½
                      IIC_SCL = 0;
                      IIC_DELAY();
              
                      // å‘é€å®Œä¸€ä¸ªæ•°æ®éƒ½å°†æ—¶é’Ÿçº¿è¿›è¡Œä¸€æ¬¡çš„æ‹‰é«˜å’Œæ‹‰ä½ï¼Œå®Œæˆä¸€ä¸ªä½çš„ä¼ è¾“
                  }
              }
              
              /**
               * @brief  iic read 1 byte function
               * @param  none
               * @retval ack=1,send ack=0;ack=0,send no ack
               */
              u8 iic_read_byte(unsigned char ack)
              {
                  // unsigned char i, receive = 0;
                  u8 i;
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 9   

                  u8 receive = 0;
              
                  SDA_IN(); // SDAè®¾ç½®ä¸ºè¾“å…¥
              
                  for (i = 0; i < 8; i++)
                  { // forå¾ªç¯ï¼Œä¸€ä½ä¸€ä½çš„è¯»å–ï¼Œä»æœ€é«˜ä½ ä½7å¼€å§‹
                      IIC_SCL = 0;
                      IIC_DELAY();
                      IIC_SCL = 1;
                      receive <<= 1; // å·¦ç§»ä¸€ä½ï¼Œå‡†å¤‡ä¸‹æ¬¡çš„è¯»å–
              
                      if (IIC_SDA)
                      {
                          receive++;
                      }
                      IIC_DELAY();
                  }
              
                  if (!ack)
                  {               // ä¸éœ€è¦å‘é€
                      iic_nack(); // å‘é€nACK
                  }
                  else
                  {              // éœ€è¦å‘é€
                      iic_ack(); // å‘é€ACK
                  }
              
                  return receive;
              }
              
              /**
               * @brief  åœ¨AT24CXXé‡Œé¢çš„æŒ‡å®šåœ°å€å¼€å§‹è¯»å‡ºæŒ‡å®šä¸ªæ•°çš„æ•°æ®
               * @param  addr : å¼€å§‹è¯»å‡ºçš„åœ°å€ å¯¹24c512ä¸º0~65535
               * @param  pBuffer  : æ•°æ®æ•°ç»„é¦–åœ°å€
               * @param  num_read_data: è¦è¯»å‡ºæ•°æ®çš„ä¸ªæ•°
               * @retval u8  0--æˆåŠŸï¼Œ1--å¤±è´¥
               */
              u8 iic_eeprom_read(u16 addr, u8 *pBuffer, u16 num_read_data)
              {
                  // èµ·å§‹ä¿¡å·
                  iic_start();
              
                  // å‘é€è®¾å¤‡åœ°å€
                  // iic_send_byte(E2PROM_DEVICE_ADDR + ((device_addr / 256) << 1));
                  iic_send_byte(E2PROM_DEVICE_ADDR | IIC_WRITE_CMD);
              
                  // ç­‰å¾…åº”ç­”
                  if (iic_wait_ack())
                  {
                      return 1;
                  }
              
                  // iic_send_byte(addr / 256 >> 8); // å‘é€é«˜åœ°å€
                  iic_send_byte(addr >> 8); // å‘é€é«˜åœ°å€
              
                  // ç­‰å¾…åº”ç­”
                  if (iic_wait_ack())
                  {
                      return 1;
                  }
              
                  // iic_send_byte(addr % 256); // å‘é€ä½åœ°å€
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 10  

                  iic_send_byte(addr & 0xFF); // å‘é€ä½åœ°å€
              
                  // ç­‰å¾…åº”ç­”
                  if (iic_wait_ack())
                  {
                      return 1;
                  }
              
                  IIC_DELAY();
              
                  // èµ·å§‹ä¿¡å·
                  iic_start();
                  iic_send_byte(E2PROM_DEVICE_ADDR | IIC_READ_CMD); // è¿›å…¥æ¥æ”¶æ¨¡å¼
              
                  // ç­‰å¾…åº”ç­”
                  if (iic_wait_ack())
                  {
                      return 1;
                  }
              
                  num_read_data--;
                  while (num_read_data)
                  {
                      *pBuffer++ = iic_read_byte(1);
                      num_read_data--;
                  }
                  *pBuffer = iic_read_byte(0);
                  // åœæ­¢ä¿¡å·
                  iic_stop(); // äº§ç”Ÿä¸€ä¸ªåœæ­¢æ¡ä»¶
              
                  return 0;
              }
              
              /**
               * @brief  åœ¨AT24CXXé‡Œé¢çš„æŒ‡å®šåœ°å€å¼€å§‹å†™å…¥æŒ‡å®šä¸ªæ•°çš„æ•°æ®
               * @param  addr : å¼€å§‹å†™å…¥çš„åœ°å€ å¯¹24c512ä¸º0~65535
               * @param  pBuffer   : æ•°æ®æ•°ç»„é¦–åœ°å€
               * @param  num_write_data: è¦å†™å…¥æ•°æ®çš„ä¸ªæ•°
               * @retval 0--æ“ä½œæˆåŠŸï¼Œ1--æ“ä½œå¤±è´¥
               */
              u8 iic_eeprom_write(u16 addr, u8 *pBuffer, u16 num_write_data)
              {
                  // æ€»çº¿å‘é€ä¸€ä¸ªå¼€å§‹ä¿¡å·
                  iic_start();
              
                  // å‘é€è®¾å¤‡åœ°å€
                  // iic_send_byte(E2PROM_DEVICE_ADDR + ((device_addr / 256) << 1));
                  iic_send_byte(E2PROM_DEVICE_ADDR | IIC_WRITE_CMD);
              
                  // åº”ç­”ä¿¡å·ï¼Œç­‰å¾…ä»æœºåº”ç­”
                  if (iic_wait_ack())
                  {
                      return 1; // è¡¨ç¤ºæ“ä½œå¤±è´¥ï¼Œæ²¡æœ‰æ”¶åˆ°åº”ç­”
                  }
              
                  // iic_send_byte(addr / 256 >> 8); // å‘é€é«˜åœ°å€
                  iic_send_byte(addr >> 8); // å‘é€é«˜åœ°å€
              
                  // åº”ç­”ä¿¡å·ï¼Œç­‰å¾…ä»æœºåº”ç­”
                  if (iic_wait_ack())
                  {
                      return 1; // è¡¨ç¤ºæ“ä½œå¤±è´¥ï¼Œæ²¡æœ‰æ”¶åˆ°åº”ç­”
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 11  

                  }
              
                  // iic_send_byte(addr % 256); // å‘é€ä½åœ°å€
                  iic_send_byte(addr & 0xFF); // å‘é€ä½åœ°å€
              
                  // åº”ç­”ä¿¡å·ï¼Œç­‰å¾…ä»æœºåº”ç­”
                  if (iic_wait_ack())
                  {
                      return 1; // è¡¨ç¤ºæ“ä½œå¤±è´¥ï¼Œæ²¡æœ‰æ”¶åˆ°åº”ç­”
                  }
              
                  while (num_write_data--)
                  {
                      iic_send_byte(*pBuffer); // å‘é€å­—èŠ‚
                      if (iic_wait_ack())
                      {
                          return 1; // è¡¨ç¤ºæ“ä½œå¤±è´¥ï¼Œæ²¡æœ‰æ”¶åˆ°åº”ç­”
                      }
              
                      addr++;
                      pBuffer++;
                  }
              
                  IIC_DELAY();
                  // æ€»çº¿å‘é€ä¸€ä¸ªåœæ­¢ä¿¡å·
                  iic_stop(); // äº§ç”Ÿä¸€ä¸ªåœæ­¢æ¡ä»¶
              
                  return 0; // è¡¨ç¤ºæ“ä½œæˆåŠŸ
              }
              
              void eeprom_24cxx_write(u8 page_id, u8 *p_buf, u16 len)
              {
                  u16 addr = EEPROM_PAGE_X_ADDR(page_id);
              
                  while (iic_eeprom_write(addr, p_buf, len))
                  {
                      // printf("time out\n");
                      WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
                  };
              }
              
              void eeprom_24cxx_read(u8 page_id, u8 *p_buf, u16 len)
              {
                  u16 addr = EEPROM_PAGE_X_ADDR(page_id);
                  while (iic_eeprom_read(addr, p_buf, len))
                  {
                      WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
                  };
              }
              
              void iic_config(void)
              {
                  // åˆå§‹åŒ–IIC
                  IIC_SDA = 1; // è®¾ç½®ä¸ºé«˜ç”µå¹³
                  IIC_SCL = 1; // è®¾ç½®ä¸ºé«˜ç”µå¹³
              
                  // P31 èŠ¯ç‰‡22è„šï¼Œç”¨ä½œSCL
                  // P26 èŠ¯ç‰‡25è„šï¼Œç”¨ä½œSDA
                  P3_MD0 &= ~GPIO_P31_MODE_SEL(0x03);
                  P3_MD0 |= GPIO_P31_MODE_SEL(0x01);
                  FOUT_S31 = GPIO_FOUT_AF_FUNC; // é€‰æ‹©AFåŠŸèƒ½è¾“å‡º
              
C51 COMPILER V9.60.7.0   IIC_SOFT                                                          12/12/2025 11:46:24 PAGE 12  

                  P2_MD1 &= ~GPIO_P26_MODE_SEL(0x03);
                  P2_MD1 |= GPIO_P26_MODE_SEL(0x1);
                  FOUT_S26 = GPIO_FOUT_AF_FUNC; // é€‰æ‹©AFåŠŸèƒ½è¾“å‡º
              }
              
              #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
