C51 COMPILER V9.60.7.0   TMR2                                                              12/12/2025 11:46:24 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TMR2
OBJECT MODULE PLACED IN .\Release\Objects\tmr2.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\tmr2.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X00
                    -0C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Rele
                    -ase\Listings\tmr2.lst) OBJECT(.\Release\Objects\tmr2.obj)

line level    source

   1          // å®šæ—¶å™¨TMR2çš„é©±åŠ¨æºæ–‡ä»¶
   2          #include "tmr2.h"
   3          
   4          // å®šæ—¶å™¨å®šæ—¶å‘¨æœŸ (å•ä½:Hz)
   5          // å‘¨æœŸå€¼ = ç³»ç»Ÿæ—¶é’Ÿ / å®šæ—¶å™¨åˆ†é¢‘ / é¢‘ç‡ - 1
   6          #define TMR2_PERIOD (SYSCLK / 1 / 20000 - 1) // 20khzï¼Œ50us
   7          // #define TMR2_PERIOD (SYSCLK / 1 / 10000 - 1) // 10khzï¼Œ100us
   8          
   9          // static volatile u8 tmr2_cnt = 0; // å®šæ—¶å™¨TMR2çš„è®¡æ•°å€¼ï¼ˆæ¯æ¬¡åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šåŠ ä¸€
             -ï¼‰
  10          
  11          /**
  12           * @brief é…ç½®å®šæ—¶å™¨TMR2ï¼Œé…ç½®å®Œæˆåï¼Œå®šæ—¶å™¨é»˜è®¤å…³é—­
  13           */
  14          void tmr2_config(void)
  15          {
  16   1          __SetIRQnIP(TMR2_IRQn, TMR2_IQn_CFG); // è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§
  17   1          __DisableIRQ(TMR2_IRQn);              // ç¦ç”¨ä¸­æ–­
  18   1          IE_EA = 1;                            // æ‰“å¼€æ€»ä¸­æ–­
  19   1      
  20   1          // æ¸…é™¤TMR2çš„è®¡æ•°å€¼
  21   1          TMR_ALLCON = TMR2_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
  22   1      
  23   1          TMR2_CONL &= ~TMR_PRESCALE_SEL(0x07); // æ¸…é™¤TMR2çš„é¢„åˆ†é¢‘é…ç½®å¯„å­˜å™¨
  24   1          TMR2_CONL |= TMR_PRESCALE_SEL(0x0);   // å®šæ—¶å™¨é¢„åˆ†é¢‘
  25   1          TMR2_CONL &= ~TMR_MODE_SEL(0x03);     // æ¸…é™¤TMR2çš„æ¨¡å¼é…ç½®å¯„å­˜å™¨
  26   1          TMR2_CONL |= TMR_MODE_SEL(0x01);      // é…ç½®TMR2çš„æ¨¡å¼ä¸ºè®¡æ•°å™¨æ¨¡å¼ï¼Œæœ€åå¯¹ç³»ç»Ÿæ—¶é’Ÿ
             -çš„è„‰å†²è¿›è¡Œè®¡æ•°
  27   1      
  28   1          // é…ç½®TMR2çš„è®¡æ•°å‘¨æœŸ
  29   1          TMR2_PRH = TMR_PERIOD_VAL_H((TMR2_PERIOD >> 8) & 0xFF); // å‘¨æœŸå€¼
  30   1          TMR2_PRL = TMR_PERIOD_VAL_L((TMR2_PERIOD >> 0) & 0xFF);
  31   1      
  32   1          // TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤TMR2çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  33   1          // TMR2_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®TMR2çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
  34   1          TMR2_CONH &= ~TMR_PRD_PND(0x01);      // æ¸…é™¤TMR2çš„è®¡æ•°æ ‡å¿—ä½ï¼Œè¡¨ç¤ºæœªå®Œæˆè®¡æ•°
  35   1          TMR2_CONH |= TMR_PRD_IRQ_EN(1);       // ä½¿èƒ½TMR2çš„è®¡æ•°ä¸­æ–­
  36   1      
  37   1          TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  38   1          TMR2_CONL |= TMR_SOURCE_SEL(0x06);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä½¿ç”¨ç³»ç»Ÿæ—¶é’Ÿ
  39   1      
  40   1          __EnableIRQ(TMR2_IRQn); // ä½¿èƒ½ä¸­æ–­ 
  41   1      }
  42          
  43          // /**
  44          //  * @brief å¼€å¯å®šæ—¶å™¨TMR2ï¼Œå¼€å§‹è®¡æ—¶
  45          //  */
  46          // void tmr2_enable(void)
  47          // {
  48          //     // é‡æ–°ç»™TMR2é…ç½®æ—¶é’Ÿ
  49          //     TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  50          //     TMR2_CONL |= TMR_SOURCE_SEL(0x06);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä½¿ç”¨ç³»ç»Ÿæ—¶é’Ÿ
  51          
C51 COMPILER V9.60.7.0   TMR2                                                              12/12/2025 11:46:24 PAGE 2   

  52          //     __EnableIRQ(TMR2_IRQn); // ä½¿èƒ½ä¸­æ–­
  53          //     IE_EA = 1;              // æ‰“å¼€æ€»ä¸­æ–­
  54          // }
  55          
  56          #if 0  // void tmr2_disable(void)
              /**
               * @brief å…³é—­å®šæ—¶å™¨ï¼Œæ¸…ç©ºè®¡æ•°å€¼
               */
              void tmr2_disable(void)
              {
                  // ä¸ç»™å®šæ—¶å™¨æä¾›æ—¶é’Ÿï¼Œè®©å®ƒåœæ­¢è®¡æ•°
                  TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
                  TMR2_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
              
                  TMR_ALLCON = TMR2_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
              
                  __DisableIRQ(TMR2_IRQn); // å…³é—­ä¸­æ–­ï¼ˆä¸ä½¿èƒ½ä¸­æ–­ï¼‰
              }
              #endif // void tmr2_disable(void)
  71          
  72          extern void update_engine_speed_scan_data(void); // æ›´æ–°æ£€æµ‹å‘åŠ¨æœºè½¬é€Ÿçš„æ•°æ®
  73          #if SPEED_SCAN_ENABLE
  74          extern void update_speed_scan_data(void);
  75          #endif // #if SPEED_SCAN_ENABLE
  76          // TMR2ä¸­æ–­æœåŠ¡å‡½æ•°
  77          void TIMR2_IRQHandler(void) interrupt TMR2_IRQn
  78          {
  79   1      // ä¸Šå‡æ²¿æ£€æµ‹
  80   1      #if ENGINE_SPEED_SCAN_ENABLE
  81   1      
  82   1          static volatile bit last_engine_speed_scan_level = 0; // è®°å½•ä¸Šä¸€æ¬¡æ£€æµ‹åˆ°çš„å¼•è„šç”µå¹³ï¼ˆå‘
             -é€æœºè½¬é€Ÿæ£€æµ‹è„šï¼‰
  83   1      
  84   1      #endif // #if ENGINE_SPEED_SCAN_ENABLE
  85   1      
  86   1      #if SPEED_SCAN_ENABLE
  87   1      
  88   1          static volatile bit last_speed_scan_level = 0; // è®°å½•ä¸Šä¸€æ¬¡æ£€æµ‹åˆ°çš„å¼•è„šç”µå¹³ï¼ˆæ—¶é€Ÿæ£€æ
             -µ‹è„šï¼‰
  89   1      
  90   1      #endif // #if SPEED_SCAN_ENABLE
  91   1      
  92   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
  93   1          __IRQnIPnPush(TMR2_IRQn);
  94   1          // P20 = 1; // æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´(çº¦3us)
  95   1      
  96   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
  97   1          // å‘¨æœŸä¸­æ–­
  98   1          if (TMR2_CONH & TMR_PRD_PND(0x1))
  99   1          {
 100   2              TMR2_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
 101   2      
 102   2      #if ENGINE_SPEED_SCAN_ENABLE
 103   2      
 104   2              { // è®°å½•å‘åŠ¨æœºè½¬é€Ÿæ‰«æçš„æ—¶é—´
 105   3                  static u8 cnt = 0;
 106   3                  cnt++;
 107   3                  if (cnt >= 20) // æ¯1msè¿›å…¥ä¸€æ¬¡
 108   3                  {
 109   4                      cnt = 0;
 110   4                      engine_speed_scan_ms++;
 111   4      
C51 COMPILER V9.60.7.0   TMR2                                                              12/12/2025 11:46:24 PAGE 3   

 112   4                      if (engine_speed_scan_ms >= ENGINE_SPEED_SCAN_OVER_TIME &&
 113   4                          flag_is_engine_speed_scan_over_time == 0)
 114   4                      {
 115   5                          engine_speed_scan_ms = 0;
 116   5                          flag_is_engine_speed_scan_over_time = 1; // è¯´æ˜è¶…æ—¶ï¼Œè„‰å†²è®¡æ•°ä¸€ç›´æ²¡æœ‰åŠ 
             -ä¸€
 117   5                      }
 118   4                  }
 119   3              }
 120   2      
 121   2              if (ENGINE_SPEED_SCAN_PIN) // æ£€æµ‹å‘åŠ¨æœºè½¬é€Ÿçš„å¼•è„š
 122   2              {
 123   3                  if (0 == last_engine_speed_scan_level)
 124   3                  {
 125   4                      // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°ä½ç”µå¹³ï¼Œç°åœ¨æ£€æµ‹åˆ°é«˜ç”µå¹³ï¼Œè¯´æ˜æœ‰ä¸Šå‡æ²¿ï¼Œå¯¹è„‰
             -å†²è®¡æ•°åŠ ä¸€
 126   4                      // if (detect_engine_pulse_cnt[0] < 4294967295) // é˜²æ­¢è®¡æ•°æº¢å‡º
 127   4                      // {
 128   4                      //     detect_engine_pulse_cnt[0]++;
 129   4                      // }
 130   4                      engine_speed_scan_cnt++;
 131   4                      update_engine_speed_scan_data();
 132   4                  }
 133   3      
 134   3                  last_engine_speed_scan_level = 1;
 135   3              }
 136   2              else
 137   2              {
 138   3                  // å¦‚æœç°åœ¨æ£€æµ‹åˆ°ä½ç”µå¹³
 139   3                  last_engine_speed_scan_level = 0;
 140   3              }
 141   2      
 142   2      #endif // #if ENGINE_SPEED_SCAN_ENABLE
 143   2      
 144   2      #if SPEED_SCAN_ENABLE
 145   2              { // è®°å½•æ—¶é€Ÿæ‰«æçš„æ—¶é—´
 146   3                  static u16 cnt = 0;
 147   3                  cnt++;
 148   3                  if (cnt >= 20) // æ¯1msè¿›å…¥ä¸€æ¬¡
 149   3                  {
 150   4                      cnt = 0;
 151   4                      speed_scan_time_ms++; // æ¯1msåŠ ä¸€
 152   4      
 153   4                      // 600msï¼Œä¸ºäº†æ»¤æ‰1Hzçš„è„‰å†²ï¼Œè®¤ä¸º 1Hz==0km/h
 154   4                      if (speed_scan_time_ms >= SPEED_SCAN_OVER_TIME &&
 155   4                          flag_is_speed_scan_over_time == 0)
 156   4                      {
 157   5                          speed_scan_time_ms = 0;
 158   5                          flag_is_speed_scan_over_time = 1; // è¯´æ˜è¶…æ—¶ï¼Œè„‰å†²è®¡æ•°ä¸€ç›´æ²¡æœ‰åŠ ä¸€
 159   5                      }
 160   4                  }
 161   3              } // è®°å½•æ—¶é€Ÿæ‰«æçš„æ—¶é—´
 162   2      
 163   2              if (SPEED_SCAN_PIN) // æ£€æµ‹æ—¶é€Ÿçš„å¼•è„š
 164   2              {
 165   3                  if (0 == last_speed_scan_level)
 166   3                  {
 167   4      #if 0  // å®šæ—¶æ‰«æè„‰å†²ä¸ªæ•°æ¥è®¡ç®—æ—¶é€Ÿçš„æ–¹å¼
                     // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°ä½ç”µå¹³ï¼Œç°åœ¨æ£€æµ‹åˆ°é«˜ç”µå¹³ï¼Œè¯´æ˜æœ‰ä¸Šå‡æ²¿ï¼Œå¯¹è„‰å†²è®¡æ•°
             -åŠ ä¸€
                              if (detect_speed_pulse_cnt[0] < 4294967295) // é˜²æ­¢è®¡æ•°æº¢å‡º
                              {
C51 COMPILER V9.60.7.0   TMR2                                                              12/12/2025 11:46:24 PAGE 4   

                                  detect_speed_pulse_cnt[0]++;
                              }
              #endif // å®šæ—¶æ‰«æè„‰å†²ä¸ªæ•°æ¥è®¡ç®—æ—¶é€Ÿçš„æ–¹å¼
 174   4      
 175   4                      speed_pulse_cnt++;
 176   4                      update_speed_scan_data();
 177   4                  }
 178   3      
 179   3                  last_speed_scan_level = 1;
 180   3              }
 181   2              else
 182   2              {
 183   3                  // å¦‚æœç°åœ¨æ£€æµ‹åˆ°ä½ç”µå¹³
 184   3                  last_speed_scan_level = 0;
 185   3              }
 186   2      #endif
 187   2          }
 188   1      
 189   1          // P20 = 0; // æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´
 190   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 191   1          __IRQnIPnPop(TMR2_IRQn);
 192   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    332    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
