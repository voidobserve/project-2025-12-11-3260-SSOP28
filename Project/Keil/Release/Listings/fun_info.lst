C51 COMPILER V9.60.7.0   FUN_INFO                                                          12/05/2025 17:28:59 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE FUN_INFO
OBJECT MODULE PLACED IN .\Release\Objects\fun_info.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\fun_info.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X00
                    -0C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Rele
                    -ase\Listings\fun_info.lst) OBJECT(.\Release\Objects\fun_info.obj)

line level    source

   1          #include "fun_info.h"
   2          #include <string.h> // memset()
   3          
   4          volatile fun_info_t fun_info; // å­˜æ”¾æ‰€æœ‰åŠŸèƒ½çŠ¶æ€çš„ç»“æ„ä½“å˜é‡
   5          
   6          // åˆå§‹åŒ–å­˜æ”¾æ‰€æœ‰ä¿¡æ¯çš„ç»“æ„ä½“å˜é‡
   7          void fun_info_init(void)
   8          {
   9   1      #if (USE_EEPROM_SAVE_DATA)
                  // #if USE_EEPROM_SAVE_DATA
                  u8 page_id;
                  u32 temp_total_mileage; // ä¸´æ—¶å­˜æ”¾ä»eepromè¯»å‡ºçš„æ€»é‡Œç¨‹æ•°æ®
              
                  /* å…¨å±€å˜é‡ï¼Œä¸Šç”µåº”è¯¥é»˜è®¤ä¸º0 */
                  // fun_info.save_info.total_mileage = 0;
                  // fun_info.save_info.subtotal_mileage = 0;
                  // fun_info.save_info.subtotal_mileage_2 = 0;
              
                  eeprom_menu_init();
                  page_id = eeprom_menu_prev.cur_write_page_id; // è·å–ç›®å½•çš„id
              
                  /*
                      åº”è¯¥å°†åŒä¸€ç»„çš„æ•°æ®éƒ½è¯»å‡ºæ¥ï¼Œæ¯”è¾ƒæ€»é‡Œç¨‹çš„å¤§å°ï¼Œä»¥è¾ƒå¤§çš„ä¸ºæœ€æ–°çš„æ•°æ
             -®ã€‚
                      è¾ƒå°çš„å¯èƒ½æ˜¯å› ä¸ºå†™å…¥eepromæ—¶çªç„¶æ‰ç”µï¼Œä¸­æ–­äº†å†™å…¥
                  */
                  // æ ¹æ®ä»ç›®å½•è¯»å–åˆ°çš„é¡µé¢idï¼Œæ‰¾åˆ°å¯¹åº”çš„æ•°æ®
                  eeprom_24cxx_read(page_id, (u8 *)&eeprom_saveinfo, sizeof(eeprom_saveinfo_t));
                  if (eeprom_saveinfo.is_data_valid == EEPROM_DATA_VALID_VAL)
                  {
                      fun_info.save_info.total_mileage = eeprom_saveinfo.total_mileage;
                      fun_info.save_info.subtotal_mileage = eeprom_saveinfo.subtotal_mileage;
                      fun_info.save_info.subtotal_mileage_2 = eeprom_saveinfo.subtotal_mileage_2;
              
                      temp_total_mileage = fun_info.save_info.total_mileage;
                  }
              
                  // æ‰¾åˆ°å®ƒåŒä¸€ç»„çš„å¦ä¸€ä¸ªé¡µé¢ï¼Œçœ‹çœ‹å¦ä¸€ä¸ªé¡µé¢çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                  if (page_id % 2 == 0)
                  {
                      /*
                          å¦‚æœæ˜¯å¶æ•°é¡µé¢id
                          å¾—åˆ°çš„å¶æ•°ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬ä¸€ä¸ªé¡µé¢ prev
                          å¾—åˆ°çš„å¶æ•° + 1ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬äºŒä¸ªé¡µé¢ next
                      */
                      page_id += 1;
                  }
                  else
                  {
                      /*
                          å¦‚æœæ˜¯å¥‡æ•°é¡µé¢idï¼Œ
                          å¾—åˆ°çš„å¥‡æ•° - 1ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬ä¸€ä¸ªé¡µé¢ prev
                          å¾—åˆ°çš„å¥‡æ•°ï¼Œä½œä¸ºåŒä¸€ç»„é¡µé¢çš„ç¬¬äºŒä¸ªé¡µé¢ next
C51 COMPILER V9.60.7.0   FUN_INFO                                                          12/05/2025 17:28:59 PAGE 2   

                      */
                      page_id -= 1;
                  }
              
                  eeprom_24cxx_read(page_id, (u8 *)&eeprom_saveinfo, sizeof(eeprom_saveinfo_t));
                  if (eeprom_saveinfo.is_data_valid == EEPROM_DATA_VALID_VAL)
                  {
                      // å¦‚æœè¯¥é¡µé¢çš„æ•°æ®æœ‰æ•ˆï¼Œå°†æ•°æ®è¯»å‡º
                      if (temp_total_mileage >= eeprom_saveinfo.total_mileage)
                      {
                      }
                      else
                      {
                          fun_info.save_info.total_mileage = eeprom_saveinfo.total_mileage;
                          fun_info.save_info.subtotal_mileage = eeprom_saveinfo.subtotal_mileage;
                          fun_info.save_info.subtotal_mileage_2 = eeprom_saveinfo.subtotal_mileage_2;
                      }
                  }
              
                  /*
                      è¿è¡Œåˆ°è¿™é‡Œï¼Œå¦‚æœä¸¤ä¸ªé¡µé¢çš„æ•°æ®éƒ½æ— æ•ˆ
                      is_data_valid éƒ½ä¸ç­‰äº EEPROM_DATA_VALID_VALï¼Œ
                      é‚£ä¹ˆ fun_info.save_info åº”è¯¥æ²¡æœ‰è¢«èµ‹å€¼ï¼Œéƒ½ä¸º0
                  */
              
                  // printf("total_mileage %lu\n", fun_info.save_info.total_mileage);
                  // printf("sub_total_mileage %lu\n", fun_info.save_info.subtotal_mileage);
                  // printf("sub_total_mileage_2 %lu\n", fun_info.save_info.subtotal_mileage_2);
              #elif USE_INTERNAL_FLASH_SAVE_DATA
  82   1      
  83   1          save_info_t save_info;
  84   1          flash_read(FLASH_START_ADDR, (u8 *)&save_info, sizeof(save_info_t));
  85   1          if (USER_FLASH_DATA_VALID_VAL == save_info.is_save_data_valid)
  86   1          {
  87   2              fun_info.save_info.total_mileage = save_info.total_mileage;
  88   2              fun_info.save_info.subtotal_mileage = save_info.subtotal_mileage;
  89   2              fun_info.save_info.subtotal_mileage_2 = save_info.subtotal_mileage_2;
  90   2          }
  91   1          else
  92   1          {
  93   2              // å¦‚æœä¿å­˜åœ¨flashä¸­çš„æ•°æ®æ— æ•ˆï¼Œå…¨å±€å˜é‡ fun_info é»˜è®¤å…¨éƒ¨ä¸º0
  94   2          }
  95   1      
  96   1      #endif
  97   1      }
  98          
  99          // ä¿å­˜ å­˜æ”¾äº†æ‰€æœ‰ä¿¡æ¯çš„ç»“æ„ä½“å˜é‡ï¼Œå†™å…¥flashä¸­
 100          void fun_info_save(void)
 101          {
 102   1          // DEBUG ï¼š
 103   1          // printf("eeprom save begin\n"); // æ‰“å°è¿™å¥è¯æ—¶ï¼Œå¯ä»¥è¯•è¯•çªç„¶æ–­ç”µï¼Œæµ‹è¯•eepromçªç„
             -¶æ–­ç”µåï¼Œä¼šä¸ä¼šå½±å“æ•´ä¸ªé‡Œç¨‹è®°å½•çš„æ•°æ®
 104   1      
 105   1      #if USE_EEPROM_SAVE_DATA
                  eeprom_data_save();
              #elif USE_INTERNAL_FLASH_SAVE_DATA
 108   1          // æ³¨æ„å…ˆæ“¦é™¤æ‰‡åŒºå†å†™å…¥
 109   1          flash_erase_sector(FLASH_START_ADDR);                              // æ“¦é™¤æŒ‡å®šæ‰‡åŒº
 110   1          fun_info.save_info.is_save_data_valid = USER_FLASH_DATA_VALID_VAL; // è¡¨ç¤ºæ•°æ®æœ‰æ•ˆï¼Œè®©ä¸‹ä¸€æ¬
             -¡ä¸Šç”µè¯»å‡ºæ•°æ®æ—¶ï¼ŒéªŒè¯è¯¥æ ‡å¿—ä½
 111   1          flash_program(FLASH_START_ADDR, (u8 *)&fun_info.save_info, sizeof(save_info_t));
 112   1      #endif
C51 COMPILER V9.60.7.0   FUN_INFO                                                          12/05/2025 17:28:59 PAGE 3   

 113   1      
 114   1          // DEBUG ï¼š
 115   1          // printf("eeprom save\n");
 116   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =     89    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     38      13
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
